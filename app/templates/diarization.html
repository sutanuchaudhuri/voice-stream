<!DOCTYPE html>
<html>
<head>
    <title>Speaker Diarization - Voice Stream App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body { background: #f8f9fa; }
        .container { max-width: 1000px; margin-top: 40px; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 32px; }
        .speaker-segment { border-radius: 8px; margin-bottom: 15px; padding: 15px; border-left: 4px solid; }
        .speaker-header { display: flex; align-items: center; margin-bottom: 10px; }
        .speaker-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; border: 2px solid; }
        .speaker-name { font-weight: bold; font-size: 1.2em; margin-right: 15px; }
        .timestamp { font-size: 0.9em; color: #6c757d; }
        .speaker-text { font-size: 1.1em; line-height: 1.5; }
        .timeline-container { background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 20px 0; }
        .timeline { height: 30px; border-radius: 6px; overflow: hidden; border: 1px solid #dee2e6; margin-top: 10px; }
        .timeline-segment { display: inline-block; height: 100%; cursor: pointer; transition: opacity 0.3s; }
        .timeline-segment:hover { opacity: 0.8; }
        .navigation-menu { margin-bottom: 20px; }
        .upload-area { border: 2px dashed #dee2e6; border-radius: 8px; padding: 30px; text-align: center; margin: 20px 0; transition: border-color 0.3s; }
        .upload-area:hover { border-color: #007bff; }
        .upload-area.dragover { border-color: #007bff; background-color: #f0f8ff; }
        .no-results { text-align: center; padding: 40px; color: #6c757d; }
        .speaker-controls { margin-top: 15px; }
        .speaker-controls input { margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation Menu -->
        <div class="navigation-menu">
            <nav class="navbar navbar-expand-lg navbar-light bg-light rounded">
                <div class="container-fluid">
                    <span class="navbar-brand mb-0 h1">Voice Stream App</span>
                    <div class="navbar-nav">
                        <a class="nav-link" href="/">Main App</a>
                        <a class="nav-link active" href="/diarization">Speaker Diarization</a>
                        <a class="nav-link" href="/audio-annotation">Audio Annotation</a>
                    </div>
                </div>
            </nav>
        </div>

        <h1 class="mb-4">üé§ Speaker Diarization</h1>

        <!-- Mode Selection -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Diarization Mode</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="diarization-mode" id="upload-mode" value="upload" checked>
                            <label class="form-check-label" for="upload-mode">
                                <strong>üìÅ File Upload Mode</strong><br>
                                <small class="text-muted">Upload an audio file for speaker diarization</small>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="diarization-mode" id="streaming-mode" value="streaming">
                            <label class="form-check-label" for="streaming-mode">
                                <strong>üéôÔ∏è Live Streaming Mode</strong><br>
                                <small class="text-muted">Record live audio with real-time speaker detection</small>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Area -->
        <div class="upload-area" id="upload-area">
            <div class="mb-3">
                <h5>Upload Audio for Speaker Diarization</h5>
                <p class="text-muted">Drag and drop an audio file here, or click to select</p>
                <input type="file" id="audio-upload" accept="audio/*" class="form-control" style="max-width: 300px; margin: 0 auto;">
            </div>
            <div class="mb-3">
                <label for="language-select" class="form-label">Language:</label>
                <select id="language-select" class="form-select" style="max-width: 200px; margin: 0 auto;">
                    <option value="en" selected>English</option>
                    <option value="hi">Hindi</option>
                    <option value="es">Spanish</option>
                </select>
            </div>
            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="enable-denoising">
                <label class="form-check-label" for="enable-denoising">Enable noise reduction</label>
            </div>
            <button id="process-btn" class="btn btn-primary" disabled>Process Audio</button>
        </div>

        <!-- Streaming Area -->
        <div class="card" id="streaming-area" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">üéôÔ∏è Live Speaker Diarization</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="streaming-language-select" class="form-label">Language:</label>
                        <select id="streaming-language-select" class="form-select">
                            <option value="en" selected>English</option>
                            <option value="hi">Hindi</option>
                            <option value="es">Spanish</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="segment-duration" class="form-label">Processing Interval:</label>
                        <select id="segment-duration" class="form-select">
                            <option value="5">5 seconds</option>
                            <option value="10" selected>10 seconds</option>
                            <option value="15">15 seconds</option>
                            <option value="20">20 seconds</option>
                            <option value="30">30 seconds</option>
                            <option value="60">1 minute</option>
                            <option value="120">2 minutes</option>
                            <option value="300">5 minutes</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="streaming-enable-denoising">
                            <label class="form-check-label" for="streaming-enable-denoising">Enable noise reduction</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="auto-speaker-detect">
                            <label class="form-check-label" for="auto-speaker-detect">Auto-detect new speakers</label>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <button id="start-streaming-btn" class="btn btn-success btn-lg me-2">
                        <i class="bi bi-mic"></i> Start Recording
                    </button>
                    <button id="stop-streaming-btn" class="btn btn-danger btn-lg" style="display: none;">
                        <i class="bi bi-stop"></i> Stop Recording
                    </button>
                    <div id="streaming-status" class="mt-2">
                        <span id="recording-indicator" style="display: none; color: red; font-weight: bold;">‚óè RECORDING</span>
                        <span id="processing-indicator" style="display: none; color: orange; font-weight: bold;">‚ö° PROCESSING</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Processing Status -->
        <div id="processing-status" class="alert alert-info" style="display: none;">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                <span id="status-text">Processing audio...</span>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" style="display: none;">
            <h3 class="mb-3">Diarization Results</h3>

            <!-- Timeline Visualization -->
            <div class="timeline-container">
                <h5>Speaker Timeline</h5>
                <p class="text-muted small">Visual representation of when each speaker talks</p>
                <div id="timeline" class="timeline"></div>
                <div id="timeline-legend" class="mt-2"></div>
            </div>

            <!-- Speaker Controls -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Speaker Settings</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Customize speaker names and colors:</p>
                    <div id="speaker-controls"></div>
                </div>
            </div>

            <!-- Transcript -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Conversation Transcript</h5>
                </div>
                <div class="card-body">
                    <div id="transcript-container"></div>
                </div>
            </div>
        </div>

        <!-- No Results -->
        <div id="no-results" class="no-results" style="display: none;">
            <h4>No diarization results</h4>
            <p>Upload an audio file to see speaker diarization results, or check if there are results from the main app.</p>
        </div>
    </div>

    <script>
        let socket = null;
        let currentResults = null;
        let speakerSettings = {};
        let mediaRecorder = null;
        let audioChunks = [];
        let streamingInterval = null;
        let accumulatedResults = [];
        let isSocketConnected = false;

        // Initialize socket connection only once
        function initializeSocket() {
            if (socket && isSocketConnected) {
                return; // Already connected
            }

            socket = io();

            socket.on('connect', function() {
                console.log('Socket connected');
                isSocketConnected = true;
            });

            socket.on('disconnect', function() {
                console.log('Socket disconnected');
                isSocketConnected = false;
            });

            // Listen for streaming results from server
            socket.on('streaming_diarization_update', function(data) {
                if (data.diarization && Array.isArray(data.diarization) && data.diarization.length > 0) {
                    // Accumulate results from streaming segments
                    accumulatedResults = accumulatedResults.concat(data.diarization);

                    // Update display in real-time
                    displayResults(accumulatedResults);

                    // Save updated results
                    sessionStorage.setItem('diarizationResults', JSON.stringify(accumulatedResults));

                    // Show results section if not already visible
                    if (document.getElementById('results-section').style.display === 'none') {
                        document.getElementById('results-section').style.display = 'block';
                        document.getElementById('no-results').style.display = 'none';
                    }
                }
            });

            // Handle regular transcription updates for file uploads
            socket.on('transcription_update', function(data) {
                if (data.diarization && Array.isArray(data.diarization) && data.diarization.length > 0) {
                    displayResults(data.diarization);
                    sessionStorage.setItem('diarizationResults', JSON.stringify(data.diarization));
                } else {
                    hideProcessingStatus();
                    if (data.error) {
                        alert('Error processing audio: ' + data.error);
                    } else {
                        alert('No speakers detected in the audio');
                    }
                    showNoResults();
                }
            });
        }

        // Check for existing results from main app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize socket connection
            initializeSocket();

            const savedResults = sessionStorage.getItem('diarizationResults');
            if (savedResults) {
                try {
                    currentResults = JSON.parse(savedResults);
                    displayResults(currentResults);
                } catch (e) {
                    console.error('Error parsing saved results:', e);
                    showNoResults();
                }
            } else {
                showNoResults();
            }

            setupModeHandlers();
            setupUploadHandlers();
            setupStreamingHandlers();
        });

        function setupModeHandlers() {
            const uploadModeRadio = document.getElementById('upload-mode');
            const streamingModeRadio = document.getElementById('streaming-mode');
            const uploadArea = document.getElementById('upload-area');
            const streamingArea = document.getElementById('streaming-area');

            uploadModeRadio.addEventListener('change', function() {
                if (this.checked) {
                    uploadArea.style.display = 'block';
                    streamingArea.style.display = 'none';
                    stopStreamingIfActive();
                }
            });

            streamingModeRadio.addEventListener('change', function() {
                if (this.checked) {
                    uploadArea.style.display = 'none';
                    streamingArea.style.display = 'block';
                }
            });
        }

        function stopStreamingIfActive() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            if (streamingInterval) {
                clearInterval(streamingInterval);
                streamingInterval = null;
            }
            // Reset streaming UI
            document.getElementById('start-streaming-btn').style.display = 'inline-block';
            document.getElementById('stop-streaming-btn').style.display = 'none';
            document.getElementById('recording-indicator').style.display = 'none';
            document.getElementById('processing-indicator').style.display = 'none';
        }

        function setupUploadHandlers() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('audio-upload');
            const processBtn = document.getElementById('process-btn');

            // File input change handler
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    processBtn.disabled = false;
                } else {
                    processBtn.disabled = true;
                }
            });

            // Drag and drop handlers
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('audio/')) {
                    fileInput.files = files;
                    processBtn.disabled = false;
                }
            });

            // Process button handler
            processBtn.addEventListener('click', processAudio);
        }

        function setupStreamingHandlers() {
            const startBtn = document.getElementById('start-streaming-btn');
            const stopBtn = document.getElementById('stop-streaming-btn');

            startBtn.addEventListener('click', startStreamingDiarization);
            stopBtn.addEventListener('click', stopStreamingDiarization);
        }

        function startStreamingDiarization() {
            const language = document.getElementById('streaming-language-select').value;
            const enableDenoising = document.getElementById('streaming-enable-denoising').checked;
            const segmentDuration = parseInt(document.getElementById('segment-duration').value) * 1000; // Convert to ms

            // Clear previous results
            accumulatedResults = [];
            currentResults = null;
            document.getElementById('results-section').style.display = 'none';

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    // Show recording indicators
                    document.getElementById('recording-indicator').style.display = 'inline';
                    document.getElementById('processing-indicator').style.display = 'none';
                    document.getElementById('start-streaming-btn').style.display = 'none';
                    document.getElementById('stop-streaming-btn').style.display = 'inline-block';

                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = () => {
                        // Process the accumulated audio chunks
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        processStreamingSegment(audioBlob, language, enableDenoising);
                        audioChunks = [];
                    };

                    // Start recording
                    mediaRecorder.start();

                    // Set up interval to process segments
                    streamingInterval = setInterval(() => {
                        if (mediaRecorder.state === 'recording') {
                            // Show processing indicator briefly
                            document.getElementById('processing-indicator').style.display = 'inline';
                            setTimeout(() => {
                                document.getElementById('processing-indicator').style.display = 'none';
                            }, 1000);

                            // Stop and restart recording to get a segment
                            mediaRecorder.stop();
                            setTimeout(() => {
                                if (mediaRecorder.state === 'inactive') {
                                    audioChunks = [];
                                    mediaRecorder.start();
                                }
                            }, 100);
                        }
                    }, segmentDuration);

                    showProcessingStatus('Live recording started - speak now!');
                    setTimeout(() => hideProcessingStatus(), 2000);
                })
                .catch(error => {
                    console.error('Error accessing microphone:', error);
                    alert('Error accessing microphone: ' + error.message);
                });
        }

        function stopStreamingDiarization() {
            stopStreamingIfActive();

            if (mediaRecorder) {
                const stream = mediaRecorder.stream;
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
            }

            showProcessingStatus('Processing final results...');

            // Display accumulated results
            setTimeout(() => {
                if (accumulatedResults.length > 0) {
                    displayResults(accumulatedResults);
                } else {
                    showNoResults();
                }
                hideProcessingStatus();
            }, 1000);
        }

        function processStreamingSegment(audioBlob, language, enableDenoising) {
            const reader = new FileReader();
            reader.onload = function() {
                const base64data = reader.result.split(',')[1];

                // Send to server for processing
                socket.emit('audio_blob', JSON.stringify({
                    audio: base64data,
                    language: language,
                    noise_cancellation: enableDenoising,
                    streaming_diarization: true,
                    segment_offset: accumulatedResults.length > 0 ?
                        Math.max(...accumulatedResults.map(r => r.end)) : 0
                }));
            };
            reader.readAsDataURL(audioBlob);
        }

        function processAudio() {
            const fileInput = document.getElementById('audio-upload');
            const language = document.getElementById('language-select').value;
            const enableDenoising = document.getElementById('enable-denoising').checked;

            if (!fileInput.files.length) {
                alert('Please select an audio file');
                return;
            }

            const file = fileInput.files[0];
            showProcessingStatus('Converting audio...');

            const reader = new FileReader();
            reader.onload = function(e) {
                const audioData = e.target.result;
                const base64Data = audioData.split(',')[1];

                showProcessingStatus('Processing with speaker diarization...');

                // Send to server for processing
                socket.emit('audio_blob', JSON.stringify({
                    audio: base64Data,
                    language: language,
                    noise_cancellation: enableDenoising,
                    diarization_only: true  // Flag for diarization-only processing
                }));
            };
            reader.readAsDataURL(file);
        }

        function showProcessingStatus(message) {
            document.getElementById('status-text').textContent = message;
            document.getElementById('processing-status').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('no-results').style.display = 'none';
        }

        function hideProcessingStatus() {
            document.getElementById('processing-status').style.display = 'none';
        }

        function showNoResults() {
            document.getElementById('no-results').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';
            hideProcessingStatus();
        }

        function displayResults(results) {
            currentResults = results;
            hideProcessingStatus();
            document.getElementById('no-results').style.display = 'none';
            document.getElementById('results-section').style.display = 'block';

            // Initialize speaker settings
            results.forEach(segment => {
                if (!speakerSettings[segment.speaker]) {
                    speakerSettings[segment.speaker] = {
                        name: segment.speaker,
                        color: getRandomColor(),
                        avatar: `https://ui-avatars.com/api/?name=${segment.speaker}&background=random`
                    };
                }
            });

            renderTimeline(results);
            renderSpeakerControls();
            renderTranscript(results);
        }

        function renderTimeline(results) {
            const timeline = document.getElementById('timeline');
            const legend = document.getElementById('timeline-legend');

            timeline.innerHTML = '';
            legend.innerHTML = '';

            if (!results || results.length === 0) return;

            const totalDuration = Math.max(...results.map(r => r.end));

            // Create timeline segments
            results.forEach(segment => {
                const width = ((segment.end - segment.start) / totalDuration) * 100;
                const div = document.createElement('div');
                div.className = 'timeline-segment';
                div.style.width = width + '%';
                div.style.backgroundColor = speakerSettings[segment.speaker].color;
                div.title = `${speakerSettings[segment.speaker].name}: ${segment.text}`;
                timeline.appendChild(div);
            });

            // Create legend
            Object.keys(speakerSettings).forEach(speaker => {
                const legendItem = document.createElement('span');
                legendItem.innerHTML = `
                    <span style="display: inline-block; width: 12px; height: 12px; background: ${speakerSettings[speaker].color}; margin-right: 5px; border-radius: 2px;"></span>
                    ${speakerSettings[speaker].name}
                `;
                legendItem.style.marginRight = '15px';
                legendItem.style.fontSize = '0.9em';
                legend.appendChild(legendItem);
            });
        }

        function renderSpeakerControls() {
            const container = document.getElementById('speaker-controls');
            container.innerHTML = '';

            Object.keys(speakerSettings).forEach(speaker => {
                const setting = speakerSettings[speaker];
                const controlDiv = document.createElement('div');
                controlDiv.className = 'mb-3';
                controlDiv.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <strong>${speaker}</strong>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm"
                                   value="${setting.name}"
                                   placeholder="Speaker name"
                                   onchange="updateSpeakerName('${speaker}', this.value)">
                        </div>
                        <div class="col-md-3">
                            <input type="color" class="form-control form-control-color form-control-sm"
                                   value="${setting.color}"
                                   onchange="updateSpeakerColor('${speaker}', this.value)">
                        </div>
                        <div class="col-md-2">
                            <img src="${setting.avatar}" alt="Avatar" class="speaker-avatar" style="width: 30px; height: 30px;">
                        </div>
                    </div>
                `;
                container.appendChild(controlDiv);
            });
        }

        function renderTranscript(results) {
            const container = document.getElementById('transcript-container');
            container.innerHTML = '';

            results.forEach(segment => {
                const setting = speakerSettings[segment.speaker];
                const segmentDiv = document.createElement('div');
                segmentDiv.className = 'speaker-segment';
                segmentDiv.style.borderLeftColor = setting.color;
                segmentDiv.style.backgroundColor = setting.color + '10'; // Add transparency

                segmentDiv.innerHTML = `
                    <div class="speaker-header">
                        <img src="${setting.avatar}" alt="Avatar" class="speaker-avatar" style="border-color: ${setting.color};">
                        <span class="speaker-name" style="color: ${setting.color};">${setting.name}</span>
                        <span class="timestamp">[${segment.start.toFixed(1)}s - ${segment.end.toFixed(1)}s]</span>
                    </div>
                    <div class="speaker-text">${segment.text}</div>
                `;
                container.appendChild(segmentDiv);
            });
        }

        function updateSpeakerName(speaker, newName) {
            speakerSettings[speaker].name = newName;
            renderTimeline(currentResults);
            renderTranscript(currentResults);
        }

        function updateSpeakerColor(speaker, newColor) {
            speakerSettings[speaker].color = newColor;
            renderTimeline(currentResults);
            renderSpeakerControls();
            renderTranscript(currentResults);
        }

        function getRandomColor() {
            const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#20c997', '#fd7e14', '#e83e8c'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
    </script>
</body>
</html>
